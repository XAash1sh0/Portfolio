<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spatial Adventure Lab</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: sans-serif; }
    .toolbox { padding: 20px; max-width: 1000px; margin: auto; }
    .tool-card { background: #f0f0f0; padding: 10px; margin: 10px 0; cursor: pointer; border-radius: 8px; }
    #map { height: 80vh; width: 100%; margin-top: 20px; }
    #results { background: #e5e7eb; padding: 10px; border-radius: 5px; margin-top: 10px; }
  </style>
</head>
<body>

<div class="toolbox">
  <h2>🧪 Spatial Adventure Lab</h2>

  <div class="tool-card" onclick="fetchAndBuffer()">🛣️ Road Wrangler</div>
  <div class="tool-card" onclick="fetchAmenities()">🏪 Amenity Scanner</div>
  <div class="tool-card" onclick="countByType()">📈 Insight Analyzer</div>

  <div id="results">🔍 Tool feedback and results will appear here.</div>
  <div id="map"></div>
</div>

<script>
  const map = L.map('map').setView([27.7172, 85.3240], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  let roadLayer, bufferLayer, amenityLayer;
  let roadsGeoJSON = null, bufferGeoJSON = null, amenitiesGeoJSON = null;

  async function fetchAndBuffer() {
    clearLayers();
    document.getElementById('results').innerText = "🛠 Fetching roads and buffering...";
    const query = `[out:json];way["highway"](27.69,85.28,27.74,85.36);out geom;`;
    const res = await fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query });
    const data = await res.json();
    const features = data.elements.map(way => ({
      type: "Feature", geometry: { type: "LineString", coordinates: way.geometry.map(p => [p.lon, p.lat]) }, properties: {}
    }));
    roadsGeoJSON = { type: "FeatureCollection", features };
    roadLayer = L.geoJSON(roadsGeoJSON, { color: '#4f46e5' }).addTo(map);
    bufferGeoJSON = turf.buffer(roadsGeoJSON, 0.1, { units: 'kilometers' });
    bufferLayer = L.geoJSON(bufferGeoJSON, { color: 'red', fillOpacity: 0.2 }).addTo(map);
    document.getElementById('results').innerText = "✅ Roads buffered (100m)";
  }

  async function fetchAmenities() {
    if (!bufferGeoJSON) return alert("Run Road Wrangler first!");
    document.getElementById('results').innerText = "🔍 Scanning for amenities...";
    const query = `[out:json];node["amenity"](27.69,85.28,27.74,85.36);out;`;
    const res = await fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query });
    const data = await res.json();
    const features = data.elements.map(n => ({
      type: "Feature",
      properties: { amenity: n.tags.amenity },
      geometry: { type: "Point", coordinates: [n.lon, n.lat] }
    }));
    amenitiesGeoJSON = {
      type: "FeatureCollection",
      features: features.filter(f => turf.booleanPointInPolygon(f, bufferGeoJSON))
    };
    amenityLayer = L.geoJSON(amenitiesGeoJSON, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius: 6, fillColor: "#10b981", color: "#047857", weight: 1, fillOpacity: 0.8
      }).bindPopup(`Amenity: ${f.properties.amenity}`)
    }).addTo(map);
    document.getElementById('results').innerText = `✅ Found ${amenitiesGeoJSON.features.length} amenities.`;
  }

  function countByType() {
    if (!amenitiesGeoJSON) return alert("Run Amenity Scanner first!");
    const counts = {};
    amenitiesGeoJSON.features.forEach(f => counts[f.properties.amenity] = (counts[f.properties.amenity] || 0) + 1);
    let output = "📊 Amenity Summary:\n";
    for (const [type, count] of Object.entries(counts)) output += `• ${type}: ${count}\n`;
    document.getElementById('results').innerText = output;
  }

  function clearLayers() {
    if (roadLayer) map.removeLayer(roadLayer);
    if (bufferLayer) map.removeLayer(bufferLayer);
    if (amenityLayer) map.removeLayer(amenityLayer);
  }
</script>
</body>
</html>
